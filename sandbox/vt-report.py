#!/usr/bin/env python3
"""
A script for pulling down detailed information from virustotal on a provided
sample hash. Returns the json report for parsing.

author: @linkavych
date: 2022-07-22
"""
import os
import sys
import json

# web request stuff
from urllib.parse import urljoin
import requests

# CLI stuff
from typing import Optional
import typer
from rich import print
from rich.console import Console
from rich.table import Table

VT_API = os.environ["VT_API"]
BASE_URL = "https://www.virustotal.com/api/v3/files/"


def main(
    fhash: str = typer.Argument(
        ..., help="A file hash for searching the VT API for a report"
    )
):
    """
    Given a md5 or sha256 hash, query virustotal for a report and parse the returned
    json for relevant data.

    Params:
        fhash - file hash (md5, sha256)
    """
    report_url = urljoin(BASE_URL, fhash)
    headers = {"x-apikey": VT_API}

    r = requests.get(report_url, headers=headers)
    rjson = r.json()

    for k, v in rjson["data"]["attributes"].items():
        print(k, ":", v)


if __name__ == "__main__":
    typer.run(main)
