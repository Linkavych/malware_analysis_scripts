#!/usr/bin/env python3
"""
Script to interact with the Malware Bazaar API to:

- Download
- Upload
- Query

Author: @linkavych
Date: 2022-09-18
"""
import os
import requests
import hashlib
from typing import Optional

# CLI
import typer
from rich import print

BAZAAR_KEY = os.environ['BAZAAR_API']
BASE_URL = "https://mb-api.abuse.ch/api/v1/"
HEADERS = {"API-KEY": BAZAAR_KEY}

def get_filehash(fname: str):
    """
    Get the sha256 hash of a provided file

    return hash
    """
    with open(fname, 'rb') as f:
        file_bytes = f.read()
        sha256_hash = hashlib.sha256(file_bytes).hexdigest()

    return sha256_hash



def download_sample(hash: str):
    """
    Download a malware sample using a provided hash
    
    Param:
        - hash - string of md5 or sha256
    """
    payload = {"query": "get_file", "hash": hash}
    r = requests.post(BASE_URL, data=payload, headers=HEADERS, timeout=15, allow_redirects=True)
    sample = r.content

    with open(hash + '.zip', 'wb') as f:
        f.write(sample)

    return

def query_hash(hash: str):
    """
    Query a malware sample from malware bazaar
    """
    payload = {"query": "get_info", "hash": hash}
    r = requests.post(BASE_URL, data=payload, headers=HEADERS, timeout=15, allow_redirects=True)
    response = r.content.decode("utf-8", "ignore")

    print(response)


def main(fname: str):
    #download_sample(hash)

    hash = get_filehash(fname)

    query_hash(hash)

    return

if __name__ == '__main__':
    typer.run(main)
