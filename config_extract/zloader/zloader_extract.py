#!/usr/bin/env python3
"""
Configuration extractor for zloader sample
sha256: c21fbf33fe025c03f38ce6190fd011f01a3e9c03d99acd7648845c28ccbc3777

Author: @linkavych
Date: 2022-07-30
"""

import pefile
import re
import sys
from Crypto.Cipher import ARC4


def rc4_decrypt(key, data):
    return ARC4.new(key).decrypt(data)


def find_config(data):

    pattern = rb"[a-z]{20}"
    match = re.search(pattern, data)
    key = data[match.start() : match.end()]
    config = data[match.start() - 751 : match.start()]

    return key, config


def get_config(pe):

    pattern = b"[a-z]{20}"

    for sec in pe.sections:
        if b".data" in sec.Name:
            data_sec = sec.get_data()
            break

    data_section = data_sec[4:]
    key, data = find_config(data_section)

    return data, key


def main(filename):

    pe = pefile.PE(filename)

    encrypted_data, key = get_config(pe)

    decrypted_config = rc4_decrypt(key, encrypted_data)
    configs = re.findall(
        rb"[a-z]{5}:\/{2}[a-z]+\.[a-z]+\/[a-z]+\.[a-z]{3}", decrypted_config
    )
    for url in configs:
        print(url.decode())

    return


if __name__ == "__main__":
    main(sys.argv[1])
