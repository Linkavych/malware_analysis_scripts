#!/usr/bin/env python3
"""
A configuration extractor for icedid samples
Sample sha256: 9aa167baf70a86145d36ff5878dbefb14d13b111bbea97a16b48aaef42f054e3
Author: @linkavych
Date: 2022-07-30
"""
import sys
import re
import pefile
from Crypto.Cipher import ARC4


def rc4_decrypt(key, data):

    return ARC4.new(key).decrypt(data)


def main(filename):
    """
    Main function to extract the loader configuration

    Returns the decrypted configuration data
    """
    pe = pefile.PE(filename)

    key = pe.sections[2].get_data()[:8]
    data = pe.sections[2].get_data()[8:]

    dec_data = rc4_decrypt(key, data)

    configs = re.findall(rb"[a-zA-Z1-9]+\.[a-z]{3,4}", dec_data)

    for config in configs:
        print(config.decode())

    return


if __name__ == "__main__":
    main(sys.argv[1])
